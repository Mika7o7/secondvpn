<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>MATRIX VPN</title>
  <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    body,html{margin:0;padding:0;height:100%;overflow:hidden;background:#000;color:#0f0;font-family:'Courier New',monospace}
    #bg{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;opacity:0.3;z-index:-1}
    canvas{position:fixed;top:0;left:0;z-index:1}
    .container{position:relative;z-index:2;padding:20px;text-align:center}
    h1{font-size:3.5em;animation:glitch 2s infinite;letter-spacing:8px}
    @keyframes glitch{0%,100%{text-shadow:0 0 20px #0f0}50%{text-shadow:5px 5px #f00,-5px -5px #00f}}
    .btn{background:#001a00;border:2px solid #0f0;padding:18px;margin:12px;border-radius:12px;cursor:pointer;transition:.3s;display:inline-block;min-width:280px}
    .btn:hover{background:#003300;transform:scale(1.05)}
    pre{background:#000;border:2px solid #0f0;padding:15px;border-radius:10px;font-size:11px;word-break:break-all;margin:20px auto;max-width:90%}
    #qr{margin:20px auto;display:block;border:4px solid #0f0;border-radius:12px}
  </style>
</head>
<body>
  <img id="bg" src="../images/matrix.jpeg">
  <canvas id="canvas"></canvas>
  <div class="container">
    <h1>M A T R I X  V P N</h1>
    <div id="app">Загрузка серверов...</div>
  </div>

  <script>
    // Дождь из кода (как в Матрице)
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const letters = "01";
    const fontSize = 16;
    const columns = canvas.width / fontSize;
    const drops = Array(Math.floor(columns)).fill(1);
    function draw() {
      ctx.fillStyle = 'rgba(0,0,0,0.05)';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#0f0';
      ctx.font = fontSize + 'px monospace';
      for(let i = 0; i < drops.length; i++) {
        const text = letters[Math.floor(Math.random()*2)];
        ctx.fillText(text, i*fontSize, drops[i]*fontSize);
        if(drops[i]*fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
        drops[i]++;
      }
    }
    setInterval(draw, 33);

    const PROXY = "http://127.0.0.1:8000";
    fetch(PROXY + "/api/inbounds")
      .then(r => r.json())
      .then(data => {
        let html = "<h2>Выбери сервер:</h2>";
        const list = [];
        for (let k in data) list.push(...data[k]);
        list.filter(s => s.enable).forEach(s => {
          html += `<div class="btn" onclick="createKey('${s.tag}','${s.remark||s.tag}')">
            ${s.remark||s.tag}<br><small>${s.host}:${s.port}</small>
          </div>`;
        });
        document.getElementById("app").innerHTML = html;
      })
      .catch(() => document.getElementById("app").innerHTML = "<h2>Ошибка подключения к панели</h2>");

    async function createKey(tag, name) {
      const username = "tg_" + Date.now();
      await fetch(PROXY + "/api/user/" + username, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          proxies: {[tag]: {}},
          expire: Math.floor(Date.now()/1000) + 30*86400,
          data_limit: 0
        })
      });

      const link = `vless://${username}@${location.hostname}:443?security=tls#MATRIX-${name}`;
      document.getElementById("app").innerHTML = `
        <h2>КЛЮЧ ГОТОВ</h2>
        <div id="qr"></div>
        <pre>${link}</pre>
        <div class="btn" onclick="navigator.clipboard.writeText('${link}').then(()=>alert('Скопировано!'))">КОПИРОВАТЬ</div>
        <div class="btn" style="background:#300;border-color:#f00" onclick="location.reload()">НОВЫЙ КЛЮЧ</div>
      `;
      QRCode.toCanvas(document.getElementById('qr'), link, {width: 280});
    }
  </script>
</body>
</html>